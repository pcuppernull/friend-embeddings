---
title: "c"
author: "Pete Cuppernull"
date: "4/24/2022"
output:
  pdf_document: default
  html_document: default
---

# Load Libraries
```{r setup, include=FALSE}
library(tidyverse)
library(countrycode)
library(haven)
library(stargazer)
#library(jtools)
#library(lm.beta)
library(scales)
```

# Import Data

##Load DFs
```{r}
#Country projections
data <- rbind(read_csv('documents/projections/pooled_proj_v5a.csv'), read_csv('documents/projections/pooled_proj_v5b.csv'))

#dataframe linking years to sessions of congress
session_years <- read_csv('documents/projection_docs/session_years.csv')
```


##Clean Projections
```{r}
data_clean <- data %>%
  group_by(country, session_number) %>%
  mutate(count = n()) %>%
  filter(count == 20) %>% #only keep countries that appear in all 20 bootstrapped models for the session
  ungroup() %>%
  mutate(friendship = percent_rank(friendship) * 100,
         usthem = percent_rank(usthem) * 100) %>% #create percentile rank
  group_by(country, session_number) %>%
  summarise(friendship_mean = mean(friendship, na.rm = TRUE),
            usthem_mean = mean(usthem, na.rm = TRUE)) %>% #find mean rank value
  rename(session = session_number) %>%
  left_join(session_years) %>%
  mutate(year = end_year - 1) %>% #add year data
  select(country, session, year, friendship_mean:usthem_mean)

```

##Make Country List
```{r}
data_clean$country[data_clean$country == 'south_korea'] <- "south korea"
data_clean$country[data_clean$country == 'micronesia'] <- "federated states of micronesia"

data_clean_codes <- data_clean %>%
  mutate(ccode = countrycode(country, 'country.name', 'cown')) %>%
  select(country, ccode, year, 
         friendship_mean, 
         usthem_mean)

```


## Load Covariates and Combine to Projection DF

```{r}
covars <- read_csv('documents/covar_data/complete/covars_v4.csv') %>%
  rename(country = country.x)
covars <- covars %>%
  distinct()
```


```{r}
reg_data <- data_clean_codes %>%
  left_join(covars, by = c('ccode' = 'ccode', 'year' = 'year'))  %>%
  select(-country.x) %>%
  rename(country = country.y)
```


### Address missing values
```{r}
reg_data$dist[reg_data$country == "czechoslovakia"] <- 6573.925 #using  cz
reg_data$comlang_ethno[reg_data$country == "czechoslovakia"] <- 0 #using  cz
reg_data$colony[reg_data$country == "czechoslovakia"] <- 0 #using  cz

reg_data$dist[reg_data$country == "democratic_republic_of_the_congo"] <- 10262 #Distance from Kinshasa to New York
reg_data$comlang_ethno[reg_data$country == "democratic_republic_of_the_congo"] <- 0 #Distance from Kinshasa to New York
reg_data$colony[reg_data$country == "democratic_republic_of_the_congo"] <- 0 #Distance from Kinshasa to New York

reg_data$dist[reg_data$country == "east_germany"] <- 6035.334 #using germany
reg_data$comlang_ethno[reg_data$country == "east_germany"] <- 0 #using germany
reg_data$colony[reg_data$country == "east_germany"] <- 0 #using germany

reg_data$dist[reg_data$country == "romania"] <- 7656.178 #using romania
reg_data$comlang_ethno[reg_data$country == "romania"] <- 0 #using romania
reg_data$colony[reg_data$country == "romania"] <- 0 #using romania

reg_data$dist[reg_data$country == "north_yemen"] <- 11120.31 #using yemen
reg_data$comlang_ethno[reg_data$country == "north_yemen"] <- 0 #using yemen
reg_data$colony[reg_data$country == "north_yemen"] <- 0 #using yemen

reg_data$dist[reg_data$country == "south_sudan"] <- 10944 #Distance from Juba to New York
reg_data$comlang_ethno[reg_data$country == "south_sudan"] <- 0 #Distance from Juba to New York
reg_data$colony[reg_data$country == "south_sudan"] <- 0 #Distance from Juba to New York

reg_data$dist[reg_data$country == "south_vietnam"] <- 13159.26 #using vietnam
reg_data$comlang_ethno[reg_data$country == "south_vietnam"] <- 0 #using vietnam
reg_data$colony[reg_data$country == "south_vietnam"] <- 0 #using vietnam

reg_data$dist[reg_data$country == "yugoslavia"] <- 7266.376 # using yugoslavia
reg_data$comlang_ethno[reg_data$country == "yugoslavia"] <- 0 # using yugoslavia
reg_data$colony[reg_data$country == "yugoslavia"] <- 0 # using yugoslavia

```


### Preprocess covariates as needs
```{r}
# Take log of trade data
reg_data <- reg_data %>%
  mutate(flow_total_log = log(flow_total*1000000 + 1),
         flow_1to2_log = log(flow_1to2*1000000 + 1),
         flow_2to1_log = log(flow_2to1*1000000 + 1),
         dist_log = log(dist))

#Standardize CINC score to aid interpretation
reg_data <- reg_data %>%
  mutate(cinc = scale(cinc))
```

### Remove Problem Countries

Countries whose names have dual meanings in Congress (e.g. 'Georgia' the state, 'Georgia' the country), and where the alternative meaning is more common, should be removed because the word embedding strategy cannot distinguish between usagees of the synonyms.
```{r}
reg_data <- reg_data %>%
  filter(country != "georgia",
         country != "mexico",
         country != "jordan")
```


# Regressions

## Create Models

### Friendship

```{r}
# Pooled model
mod_friend <- lm(formula = friendship_mean ~ mid_last20 + 
                   flow_total_log + 
                   any_alliance + 
                   comlang_ethno + 
                   dist_log + 
                   polity_diff + 
                   cinc, data = reg_data)

summary(mod_friend)

# With time FEs - not including country because we are interested in time-invariant factors
mod_friend_fe <- lm(formula = friendship_mean ~ mid_last20 + 
                      flow_total_log + 
                      any_alliance + 
                      comlang_ethno + 
                      dist_log + 
                      polity_diff + 
                      cinc + 
                      as.factor(year), data = reg_data)

summary(mod_friend_fe)

#country and year FEs
mod_friend_cy <- lm(formula = friendship_mean ~ mid_last20 + 
                      flow_total_log + 
                      any_alliance + 
                      polity_diff + 
                      cinc + 
                      as.factor(year) + 
                      as.factor(country), data = reg_data)

summary(mod_friend_cy)
```

### Collective Identity

```{r}
# Pooled model
mod_usthem <- lm(formula = usthem_mean ~ mid_last20 + 
                   flow_total_log + 
                   any_alliance + 
                   comlang_ethno + 
                   dist_log + 
                   # colony + 
                   polity_diff + 
                   cinc, data = reg_data)

summary(mod_usthem)

# With time FEs - not including country because we are interested in time-invariant factors
mod_usthem_fe <- lm(formula = usthem_mean ~ mid_last20 + 
                      flow_total_log + 
                      any_alliance + 
                      comlang_ethno + 
                      dist_log + 
                      # colony + 
                      polity_diff + 
                      cinc + 
                      as.factor(year), data = reg_data)

summary(mod_usthem_fe)

# Add country FEs
mod_usthem_fe_cy <- lm(formula = usthem_mean ~ mid_last20 + 
                         flow_total_log + 
                         any_alliance + 
                         polity_diff + 
                         cinc + 
                         as.factor(year) + 
                         as.factor(country), data = reg_data)

summary(mod_usthem_fe_cy)
```


## Create Regression Tables

### Friendship
```{r}
stargazer(mod_friend, mod_friend_fe, mod_friend_cy, omit = c('[y][e][a][r]','[c][o][u][n][t][r][y]'), 
          type = "text",
          add.lines=list(c('Year Fixed Effects', 'No', 'Yes', 'Yes'),
                         c('Country Fixed Effects', 'No', 'No', 'Yes')),
          dep.var.caption = "Friendship Percentile Rank",
          dep.var.labels.include = FALSE,
          covariate.labels = c("MID (Last 20 Years)",
                               "Total Trade Flows (Log)",
                               "Alliance",
                               "Common Language",
                               "Distance (Log)",
                               "POLITY Difference",
                               "CINC (Scaled)"),
          ci.level = .99,
          omit.stat = c("adj.rsq", "f", "ser"))
```


### Collective Identity
```{r}
stargazer(mod_usthem, mod_usthem_fe, mod_usthem_fe_cy, omit = c('[y][e][a][r]','[c][o][u][n][t][r][y]'), 
          type = "text",
          add.lines=list(c('Year Fixed Effects', 'No', 'Yes', 'Yes'),
                         c('Country Fixed Effects', 'No', 'No', 'Yes')),
          dep.var.caption = "Collective Identity Percentile Rank",
          dep.var.labels.include = FALSE,
          covariate.labels = c("MID (Last 20 Years)",
                               "Total Trade Flows (Log)",
                               "Alliance",
                               "Common Language",
                               "Distance (Log)",
                               "POLITY Difference",
                               "CINC (Scaled)"),
          ci.level = .99,
          omit.stat = c("adj.rsq", "f", "ser"))
```

## Plot Standardized Regressions over time

### Friendship

#### Estimate Models
```{r}
#Create list with each decade
decades <- list(c(1900, 1910),
             c(1910, 1920),
             c(1920, 1930),
             c(1930, 1940),
             c(1940, 1950),
             c(1950, 1960),
             c(1960, 1970),
             c(1970, 1980),
             c(1980, 1990),
             c(1990, 2000),
             c(2000, 2010))

#Function to estimate model for each decade worth of data

get_estimates_std <- function(decade){
  
mod_a <- lm(formula = scale(friendship_mean) ~ scale(mid_last20) + scale(flow_total_log) + scale(any_alliance) + scale(comlang_off) + scale(dist_log) + scale(colony) + scale(polity_diff) + scale(cinc), data = reg_data[reg_data$year >= decades[[decade]][1] & reg_data$year < decades[[decade]][2],])

results <- as.data.frame(summary(mod_a)$coefficients) %>%
  rownames_to_column('covar') %>%
  mutate(year = decades[[decade]][1])

results}

all_results <- map_dfr(1:11, get_estimates_std)

all_results
```

#### Visualize Results
```{r}
covars <- c('scale(mid_last20)', 
            'scale(flow_total_log)', 
            'scale(any_alliance)', 
            'scale(polity_diff)', 
            'scale(cinc)',
            'scale(colony)',
            'scale(dist_log)',
            'scale(comlang_off)')

#Create CI visualization
all_results <- all_results %>%
  mutate(low_95 = Estimate - 1.96*`Std. Error`,
         high_95 = Estimate + 1.96*`Std. Error`)

all_results %>%
  filter(covar %in% covars) %>%
  ggplot() +
  geom_line(aes(year, Estimate)) +
  geom_ribbon(aes(year, ymin = low_95, ymax = high_95), alpha = .1) +
  facet_wrap(~ covar, scales = "free")
```


### Collective Identity

#### Estimate Models
```{r}
get_estimates_std <- function(decade){
  
mod_a <- lm(formula = scale(usthem_mean) ~ scale(mid_last20) + scale(flow_total_log) + scale(any_alliance) + scale(comlang_off) + scale(dist_log) + scale(colony) + scale(polity_diff) + scale(cinc), data = reg_data[reg_data$year >= decades[[decade]][1] & reg_data$year < decades[[decade]][2],])

results <- as.data.frame(summary(mod_a)$coefficients) %>%
  rownames_to_column('covar') %>%
  mutate(year = decades[[decade]][1])

results}

all_results <- map_dfr(1:11, get_estimates_std)

all_results
```

#### Visualize Results
```{r}
all_results <- all_results %>%
  mutate(low_95 = Estimate - 1.96*`Std. Error`,
         high_95 = Estimate + 1.96*`Std. Error`)

all_results %>%
  filter(covar %in% covars) %>%
  ggplot() +
  geom_line(aes(year, Estimate)) +
  geom_ribbon(aes(year, ymin = low_95, ymax = high_95), alpha = .1) +
  facet_wrap(~ covar, scales = "free")
```